ZINE フロント（Next.js）を Cloud Run に出すための手順（Markdown版）

前提：スクショのとおり Next.js のルートは zine-app/。
ここでは「フロントだけをまず公開」→「（任意）Hosting リライト / CI 連携」→「API/Vertex を後から足す」までを どの階層に何を置くか含めて具体的にまとめます。
リージョン例は asia-northeast1（東京）。

⸻

用語
	•	repo ルート … README.md がある最上位ディレクトリ
	•	アプリ ルート … zine-app/（Next.js プロジェクト本体）

⸻

① どの階層に何を作るか

A. zine-app/（Next.js 側）

1) zine-app/Dockerfile（まずは“簡単版：next start”）

# ---- Build stage ----
FROM node:20-alpine AS builder
WORKDIR /app

# パッケージマネージャはどちらか1つに統一（npm 例）
COPY package*.json ./
RUN npm ci

# アプリ本体
COPY . .
RUN npm run build

# ---- Runtime stage ----
FROM node:20-alpine
WORKDIR /app
ENV NODE_ENV=production
# Cloud Run が渡す $PORT を使って listen する
ENV PORT=3000

# 生成物と必要ファイルをコピー
COPY --from=builder /app ./

# Cloud Run は 0.0.0.0:$PORT で待受が必須
EXPOSE 3000
CMD ["npm","start"]

pnpm を使う場合（置き換え）

FROM node:20-alpine AS builder
WORKDIR /app
RUN corepack enable
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile
COPY . .
RUN pnpm run build

FROM node:20-alpine
WORKDIR /app
ENV NODE_ENV=production
ENV PORT=3000
COPY --from=builder /app ./
EXPOSE 3000
CMD ["pnpm","start"]



2) zine-app/.dockerignore

node_modules
.next/cache
.git
.vscode
.DS_Store

3) zine-app/package.json（PORT を使う start を確認）

{
  "scripts": {
    "dev": "next dev -p 3001",
    "build": "next build",
    "start": "next start -p $PORT" // ← Cloud Run の $PORT を使用
  }
}

Windows 互換を意識するなら "start": "next start -p ${PORT:-3000}" でもOK。

4) （任意）軽量化したい人向け：standalone 出力
	•	zine-app/next.config.mjs に以下を追記

/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone',
};
export default nextConfig;

	•	その上で Dockerfile をこの“standalone版”に差し替え

FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM node:20-alpine
WORKDIR /app
ENV NODE_ENV=production
ENV PORT=3000
# standalone 出力だけをコピー
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/static ./.next/static
EXPOSE 3000
CMD ["node","server.js"]


⸻

B. repo ルート（zine-app/ と同じ階層）

5) cloudbuild.yaml（CI/CD 用。手動テストだけなら必須ではないが推奨）

substitutions:
  _REGION: "asia-northeast1"
  _REPO: "zine-repo"
  _SERVICE: "web"

steps:
  # Build
  - name: gcr.io/cloud-builders/docker
    args: ["build",
           "-t","${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA",
           "-f","zine-app/Dockerfile",
           "zine-app"]

  # Push
  - name: gcr.io/cloud-builders/docker
    args: ["push","${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA"]

  # Deploy to Cloud Run
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: gcloud
    args:
      ["run","deploy","${_SERVICE}",
       "--image","${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA",
       "--region","${_REGION}",
       "--platform","managed",
       "--allow-unauthenticated",
       "--quiet"]
images:
  - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA"


⸻

② 実行コマンド（この順でやれば公開まで行けます）

以降はローカルのターミナルで。gcloud init 済み・課金リンク済み前提。

# よく使う変数
REGION=asia-northeast1
REPO=zine-repo
PROJECT_ID=$(gcloud config get-value project)
IMAGE="$REGION-docker.pkg.dev/$PROJECT_ID/$REPO/web:latest"

1)（初回だけ）API を有効化 & Artifact Registry 作成

gcloud services enable run.googleapis.com artifactregistry.googleapis.com cloudbuild.googleapis.com
gcloud artifacts repositories create "$REPO" --repository-format=docker --location="$REGION"

2) Cloud Build でビルド & push（手動テスト）

# アプリのビルド対象は zine-app ディレクトリ
gcloud builds submit zine-app --tag "$IMAGE"

3) Cloud Run へデプロイ（公開）

gcloud run deploy web \
  --image="$IMAGE" \
  --region="$REGION" \
  --allow-unauthenticated

URL 取得

gcloud run services describe web --region="$REGION" --format="value(status.url)"

ログ確認（問題があれば）

gcloud logging read \
  "resource.type=cloud_run_revision AND resource.labels.service_name=web" \
  --limit=50

典型的な失敗原因：$PORT を listen していない（next start -p $PORT になっていない）。

⸻

③ Firebase Hosting → Cloud Run リライト（任意）

CDN 前段が欲しい/将来のカスタムドメイン想定ならおすすめ。
	1.	プロジェクトを Firebase 化（初回のみ）

npm i -g firebase-tools
firebase login
firebase projects:addfirebase <YOUR_PROJECT_ID>

	2.	初期化（サイトを作成）

firebase init hosting
# 既存プロジェクトを選択。public ディレクトリは任意（SSRは Cloud Run 側）

	3.	firebase.json を repo ルートに配置（Cloud Run リライト）

{
  "hosting": {
    "rewrites": [
      { "source": "**", "run": { "serviceId": "web", "region": "asia-northeast1" } }
    ]
  }
}

	4.	デプロイ

firebase deploy --only hosting


⸻

④ GitHub → Cloud Build → Cloud Run の自動化（任意だが推奨）
	1.	GCP コンソール → Cloud Build → Triggers → Connect repository で GitHub を接続
	2.	Trigger を作成
	•	Branch: ^main$
	•	Config: cloudbuild.yaml を使用
	3.	以降、git push origin main で Build → Push → Deploy が自動実行

⸻

⑤ 次の一歩：API と Vertex AI を足す（段階導入）

1) API（Express）を別コンテナで追加

repo ルートに api/ ディレクトリを作成

api/
├─ server.js
├─ package.json
└─ Dockerfile

api/server.js

import express from "express";
const app = express();
app.get("/healthz", (_, res) => res.json({ ok: true }));
app.get("/hello", (_, res) => res.json({ message: "hello from api" }));
app.listen(process.env.PORT || 8080, "0.0.0.0");

api/package.json

{
  "type": "module",
  "dependencies": { "express": "^4.19.2" },
  "scripts": { "start": "node server.js" }
}

api/Dockerfile

FROM node:20-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
ENV PORT=8080
EXPOSE 8080
CMD ["npm","start"]

ビルド & デプロイ

API_IMG="$REGION-docker.pkg.dev/$PROJECT_ID/$REPO/api:latest"
gcloud builds submit api --tag "$API_IMG"
gcloud run deploy api --image "$API_IMG" --region "$REGION" --allow-unauthenticated
API_URL=$(gcloud run services describe api --region=$REGION --format='value(status.url)')
echo $API_URL

フロントから呼ぶための環境変数（zine-app/.env.local など）

NEXT_PUBLIC_API_URL=<上で出た API_URL>

2) Vertex AI は API 側に統合
	•	Vertex AI API を有効化済みであること
	•	API の実行サービスアカウント に roles/aiplatform.user を付与
	•	Node 例（擬似コード）

import { VertexAI } from "@google-cloud/vertexai";
const vertex = new VertexAI({
  project: process.env.GCP_PROJECT,
  location: "asia-northeast1",
});
const model = vertex.getGenerativeModel({ model: "gemini-1.5-flash" });

app.post("/review", async (req, res) => {
  const { text } = req.body;
  const r = await model.generateContent({
    contents: [{ role: "user", parts: [{ text }] }],
  });
  res.json(r);
});

Cloud Run 上なら ADC（サービスアカウント）で自動認証。ローカルから叩く時は一度 gcloud auth application-default login を実行。

⸻

⑥ 小さな掃除（ロックファイルの統一）

スクショでは package-lock.json と pnpm-lock.yaml が共存。
どちらかに統一してください。
	•	npm を使う → pnpm-lock.yaml を削除し、Dockerfile/CI も npm ベースに
	•	pnpm を使う → package-lock.json を削除し、Dockerfile/CI を pnpm 版に


pc-0065_kota.akatsuka@PC-0065-adminnoMacBook-Pro ZINE-app % gcloud config list
[compute]
region = asia-northeast1
[core]
account = kouta.akatsuka@gmail.com
disable_usage_reporting = True
project = vital-analogy-470911-t0

Your active configuration is: [default]