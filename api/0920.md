# ZINE-app API エラー修正記録 (2025-09-20)

## 🔍 問題の調査結果

### 確認されたエラー

1. **Vertex AI画像キャプション処理のエラー**
   ```
   ❌ Captioning failed: SyntaxError: Unexpected token '<', "<!DOCTYPE "... is not valid JSON
   ```
   - **原因**: `locations/global`という無効なリージョン指定によりHTMLエラーページが返される
   - **影響**: 画像ベースの小説生成機能が動作しない

2. **Document AI OCR処理が動作しない**
   ```
   🔧 OCR: Document AI not configured, returning empty result
   ```
   - **原因**: 環境変数`DOC_OCR_PROCESSOR_ID`が未設定
   - **影響**: 画像内テキストの読み取り機能が動作しない

### 調査手順

```bash
# Cloud Runログの確認
gcloud logging read 'resource.type="cloud_run_revision" AND resource.labels.service_name="zine-api" AND (textPayload:"Captioning failed" OR textPayload:"OCR" OR textPayload:"Document AI")' --limit=5 --format=json --project=vital-analogy-470911-t0

# ヘルスチェック確認（404エラーを確認）
curl -s "https://zine-api-830716651527.us-central1.run.app/healthz"
```

## 🔧 実施した修正

### 1. Vertex AI ロケーション設定の修正

**api/server.ts**の以下の箇所を修正：

```typescript
// 修正前
const location = process.env.GOOGLE_CLOUD_LOCATION || "global";

// 修正後
const location = process.env.GOOGLE_CLOUD_LOCATION || "us-central1"; // Changed from 'global' to valid region
```

```typescript
// 修正前
const vertexAIGlobal = new VertexAI({
  project: project,
  location: "global", // Use global for proper model availability
  googleAuthOptions: {
    scopes: ['https://www.googleapis.com/auth/cloud-platform'],
  },
});

// 修正後
const vertexAIGlobal = new VertexAI({
  project: project,
  location: "us-central1", // Changed from 'global' to valid region for image generation
  googleAuthOptions: {
    scopes: ['https://www.googleapis.com/auth/cloud-platform'],
  },
});
```

### 2. API URLのロケーション修正

以下のAPI呼び出しURLを修正（全5箇所）：

```typescript
// 修正前
const apiUrl = `https://aiplatform.googleapis.com/v1/projects/${project}/locations/global/publishers/google/models/gemini-2.5-flash:generateContent`;

// 修正後
const apiUrl = `https://aiplatform.googleapis.com/v1/projects/${project}/locations/${location}/publishers/google/models/gemini-2.5-flash:generateContent`;
```

**修正対象のエンドポイント**:
- `/novelize` (264行目)
- `/novelize-with-images` (486行目)
- `/review` (600行目)
- `/embed` (712行目)
- `/cover` (858行目)

### 3. レスポンス検証機能の追加

HTMLエラーページを適切に検知するための`validateAndParseResponse`関数を追加：

```typescript
// 🛡️ Response validation helper
async function validateAndParseResponse(response: Response, context: string): Promise<any> {
  const contentType = response.headers.get('content-type');
  const responseText = await response.text();

  // Check if response is HTML (error page)
  if (contentType?.includes('text/html') || responseText.startsWith('<!DOCTYPE')) {
    console.error(`❌ ${context}: Received HTML error page instead of JSON`);
    console.error(`Response status: ${response.status}`);
    console.error(`HTML preview: ${responseText.substring(0, 200)}...`);
    throw new Error(`API returned HTML error page. Status: ${response.status}. Check if the location/region is valid.`);
  }

  // Check if response is valid
  if (!response.ok) {
    console.error(`❌ ${context}: HTTP error ${response.status}`);
    console.error(`Error response: ${responseText}`);
    throw new Error(`HTTP ${response.status}: ${responseText}`);
  }

  // Try to parse JSON
  try {
    return JSON.parse(responseText);
  } catch (error) {
    console.error(`❌ ${context}: Failed to parse JSON response`);
    console.error(`Response text: ${responseText.substring(0, 500)}...`);
    throw new Error(`Invalid JSON response: ${error}`);
  }
}
```

### 4. ドキュメント作成

- **DOCUMENT_AI_SETUP.md**: Document AI OCR Processor作成手順
- **FIX_DEPLOYMENT_GUIDE.md**: 完全なデプロイメント手順

## 📝 残り作業

### 1. Document AI Processorの作成

```bash
# Document AI APIを有効化
gcloud services enable documentai.googleapis.com --project=vital-analogy-470911-t0

# OCR Processorを作成
gcloud beta document-ai processors create \
  --location=us \
  --display-name="ZINE OCR Processor" \
  --type="OCR_PROCESSOR" \
  --project=vital-analogy-470911-t0

# Processor IDを取得
gcloud beta document-ai processors list \
  --location=us \
  --project=vital-analogy-470911-t0 \
  --format="value(name.segment(-1))"
```

### 2. Cloud Run環境変数の設定

```bash
# 取得したProcessor IDを環境変数に設定
gcloud run services update zine-api \
  --update-env-vars="DOC_OCR_PROCESSOR_ID=YOUR_PROCESSOR_ID,DOC_AI_LOCATION=us,GOOGLE_CLOUD_LOCATION=us-central1" \
  --region=us-central1 \
  --project=vital-analogy-470911-t0
```

### 3. 権限の付与

```bash
#必要な権限を付与
gcloud projects add-iam-policy-binding vital-analogy-470911-t0 \
  --member="serviceAccount:830716651527-compute@developer.gserviceaccount.com" \
  --role="roles/documentai.apiUser"

gcloud projects add-iam-policy-binding vital-analogy-470911-t0 \
  --member="serviceAccount:830716651527-compute@developer.gserviceaccount.com" \
  --role="roles/aiplatform.user"
```

## 📊 期待される結果

修正後、以下のエラーが解消される予定：

❌ **解消されるエラー**:
- `❌ Captioning failed: SyntaxError: Unexpected token '<'`
- `🔧 OCR: Document AI not configured, returning empty result`

✅ **正常なログ**:
- `📄 Document AI OCR initialized: projects/.../processors/...`
- `🎨 Caption generated for page...`
- `📄 OCR processed: XXX chars, confidence: X.XX`

## 🔄 修正ファイル

- ✅ `api/server.ts` - Vertex AI設定とAPI URL修正
- ✅ `api/DOCUMENT_AI_SETUP.md` - Document AI設定手順
- ✅ `api/FIX_DEPLOYMENT_GUIDE.md` - デプロイメント手順
- ✅ `api/0920.md` - 本記録ファイル

## 📈 影響範囲

**復旧する機能**:
- 画像ベースの小説生成機能
- AI画像キャプション生成
- OCRによる画像内テキスト抽出
- 表紙画像の自動生成

**テスト対象**:
- `/novelize-with-images` エンドポイント
- `/cover` エンドポイント
- 画像アップロード→小説変換のフルワークフロー