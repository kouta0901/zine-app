# ZINE-app API ã‚¨ãƒ©ãƒ¼ä¿®æ­£è¨˜éŒ² (2025-09-20)

## ğŸ” å•é¡Œã®èª¿æŸ»çµæœ

### ç¢ºèªã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼

1. **Vertex AIç”»åƒã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³å‡¦ç†ã®ã‚¨ãƒ©ãƒ¼**
   ```
   âŒ Captioning failed: SyntaxError: Unexpected token '<', "<!DOCTYPE "... is not valid JSON
   ```
   - **åŸå› **: `locations/global`ã¨ã„ã†ç„¡åŠ¹ãªãƒªãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šã«ã‚ˆã‚ŠHTMLã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹
   - **å½±éŸ¿**: ç”»åƒãƒ™ãƒ¼ã‚¹ã®å°èª¬ç”Ÿæˆæ©Ÿèƒ½ãŒå‹•ä½œã—ãªã„

2. **Document AI OCRå‡¦ç†ãŒå‹•ä½œã—ãªã„**
   ```
   ğŸ”§ OCR: Document AI not configured, returning empty result
   ```
   - **åŸå› **: ç’°å¢ƒå¤‰æ•°`DOC_OCR_PROCESSOR_ID`ãŒæœªè¨­å®š
   - **å½±éŸ¿**: ç”»åƒå†…ãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿å–ã‚Šæ©Ÿèƒ½ãŒå‹•ä½œã—ãªã„

### èª¿æŸ»æ‰‹é †

```bash
# Cloud Runãƒ­ã‚°ã®ç¢ºèª
gcloud logging read 'resource.type="cloud_run_revision" AND resource.labels.service_name="zine-api" AND (textPayload:"Captioning failed" OR textPayload:"OCR" OR textPayload:"Document AI")' --limit=5 --format=json --project=vital-analogy-470911-t0

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèªï¼ˆ404ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªï¼‰
curl -s "https://zine-api-830716651527.us-central1.run.app/healthz"
```

## ğŸ”§ å®Ÿæ–½ã—ãŸä¿®æ­£

### 1. Vertex AI ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã®ä¿®æ­£

**api/server.ts**ã®ä»¥ä¸‹ã®ç®‡æ‰€ã‚’ä¿®æ­£ï¼š

```typescript
// ä¿®æ­£å‰
const location = process.env.GOOGLE_CLOUD_LOCATION || "global";

// ä¿®æ­£å¾Œ
const location = process.env.GOOGLE_CLOUD_LOCATION || "us-central1"; // Changed from 'global' to valid region
```

```typescript
// ä¿®æ­£å‰
const vertexAIGlobal = new VertexAI({
  project: project,
  location: "global", // Use global for proper model availability
  googleAuthOptions: {
    scopes: ['https://www.googleapis.com/auth/cloud-platform'],
  },
});

// ä¿®æ­£å¾Œ
const vertexAIGlobal = new VertexAI({
  project: project,
  location: "us-central1", // Changed from 'global' to valid region for image generation
  googleAuthOptions: {
    scopes: ['https://www.googleapis.com/auth/cloud-platform'],
  },
});
```

### 2. API URLã®ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¿®æ­£

ä»¥ä¸‹ã®APIå‘¼ã³å‡ºã—URLã‚’ä¿®æ­£ï¼ˆå…¨5ç®‡æ‰€ï¼‰ï¼š

```typescript
// ä¿®æ­£å‰
const apiUrl = `https://aiplatform.googleapis.com/v1/projects/${project}/locations/global/publishers/google/models/gemini-2.5-flash:generateContent`;

// ä¿®æ­£å¾Œ
const apiUrl = `https://aiplatform.googleapis.com/v1/projects/${project}/locations/${location}/publishers/google/models/gemini-2.5-flash:generateContent`;
```

**ä¿®æ­£å¯¾è±¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
- `/novelize` (264è¡Œç›®)
- `/novelize-with-images` (486è¡Œç›®)
- `/review` (600è¡Œç›®)
- `/embed` (712è¡Œç›®)
- `/cover` (858è¡Œç›®)

### 3. ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼æ©Ÿèƒ½ã®è¿½åŠ 

HTMLã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã‚’é©åˆ‡ã«æ¤œçŸ¥ã™ã‚‹ãŸã‚ã®`validateAndParseResponse`é–¢æ•°ã‚’è¿½åŠ ï¼š

```typescript
// ğŸ›¡ï¸ Response validation helper
async function validateAndParseResponse(response: Response, context: string): Promise<any> {
  const contentType = response.headers.get('content-type');
  const responseText = await response.text();

  // Check if response is HTML (error page)
  if (contentType?.includes('text/html') || responseText.startsWith('<!DOCTYPE')) {
    console.error(`âŒ ${context}: Received HTML error page instead of JSON`);
    console.error(`Response status: ${response.status}`);
    console.error(`HTML preview: ${responseText.substring(0, 200)}...`);
    throw new Error(`API returned HTML error page. Status: ${response.status}. Check if the location/region is valid.`);
  }

  // Check if response is valid
  if (!response.ok) {
    console.error(`âŒ ${context}: HTTP error ${response.status}`);
    console.error(`Error response: ${responseText}`);
    throw new Error(`HTTP ${response.status}: ${responseText}`);
  }

  // Try to parse JSON
  try {
    return JSON.parse(responseText);
  } catch (error) {
    console.error(`âŒ ${context}: Failed to parse JSON response`);
    console.error(`Response text: ${responseText.substring(0, 500)}...`);
    throw new Error(`Invalid JSON response: ${error}`);
  }
}
```

### 4. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ

- **DOCUMENT_AI_SETUP.md**: Document AI OCR Processorä½œæˆæ‰‹é †
- **FIX_DEPLOYMENT_GUIDE.md**: å®Œå…¨ãªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ‰‹é †

## ğŸ“ æ®‹ã‚Šä½œæ¥­

### 1. Document AI Processorã®ä½œæˆ

```bash
# Document AI APIã‚’æœ‰åŠ¹åŒ–
gcloud services enable documentai.googleapis.com --project=vital-analogy-470911-t0

# OCR Processorã‚’ä½œæˆ
gcloud beta document-ai processors create \
  --location=us \
  --display-name="ZINE OCR Processor" \
  --type="OCR_PROCESSOR" \
  --project=vital-analogy-470911-t0

# Processor IDã‚’å–å¾—
gcloud beta document-ai processors list \
  --location=us \
  --project=vital-analogy-470911-t0 \
  --format="value(name.segment(-1))"
```

### 2. Cloud Runç’°å¢ƒå¤‰æ•°ã®è¨­å®š

```bash
# å–å¾—ã—ãŸProcessor IDã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
gcloud run services update zine-api \
  --update-env-vars="DOC_OCR_PROCESSOR_ID=YOUR_PROCESSOR_ID,DOC_AI_LOCATION=us,GOOGLE_CLOUD_LOCATION=us-central1" \
  --region=us-central1 \
  --project=vital-analogy-470911-t0
```

### 3. æ¨©é™ã®ä»˜ä¸

```bash
#å¿…è¦ãªæ¨©é™ã‚’ä»˜ä¸
gcloud projects add-iam-policy-binding vital-analogy-470911-t0 \
  --member="serviceAccount:830716651527-compute@developer.gserviceaccount.com" \
  --role="roles/documentai.apiUser"

gcloud projects add-iam-policy-binding vital-analogy-470911-t0 \
  --member="serviceAccount:830716651527-compute@developer.gserviceaccount.com" \
  --role="roles/aiplatform.user"
```

## ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹çµæœ

ä¿®æ­£å¾Œã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã•ã‚Œã‚‹äºˆå®šï¼š

âŒ **è§£æ¶ˆã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼**:
- `âŒ Captioning failed: SyntaxError: Unexpected token '<'`
- `ğŸ”§ OCR: Document AI not configured, returning empty result`

âœ… **æ­£å¸¸ãªãƒ­ã‚°**:
- `ğŸ“„ Document AI OCR initialized: projects/.../processors/...`
- `ğŸ¨ Caption generated for page...`
- `ğŸ“„ OCR processed: XXX chars, confidence: X.XX`

## ğŸ”„ ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«

- âœ… `api/server.ts` - Vertex AIè¨­å®šã¨API URLä¿®æ­£
- âœ… `api/DOCUMENT_AI_SETUP.md` - Document AIè¨­å®šæ‰‹é †
- âœ… `api/FIX_DEPLOYMENT_GUIDE.md` - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ‰‹é †
- âœ… `api/0920.md` - æœ¬è¨˜éŒ²ãƒ•ã‚¡ã‚¤ãƒ«

## ğŸ“ˆ å½±éŸ¿ç¯„å›²

**å¾©æ—§ã™ã‚‹æ©Ÿèƒ½**:
- ç”»åƒãƒ™ãƒ¼ã‚¹ã®å°èª¬ç”Ÿæˆæ©Ÿèƒ½
- AIç”»åƒã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
- OCRã«ã‚ˆã‚‹ç”»åƒå†…ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º
- è¡¨ç´™ç”»åƒã®è‡ªå‹•ç”Ÿæˆ

**ãƒ†ã‚¹ãƒˆå¯¾è±¡**:
- `/novelize-with-images` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- `/cover` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰â†’å°èª¬å¤‰æ›ã®ãƒ•ãƒ«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼