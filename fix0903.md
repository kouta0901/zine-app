|了解です。「常に最新版の Gemini を使う」前提で、いまのリポ（フロントのみ）に最小のバックエンド（Cloud Run）を足し、Vertex AI を3機能に配線する手順を丸ごと用意しました。|
|:----|
|モデルは Gemini 2.x/2.5 系と Imagen 3/4 を使います（1.5 は新規プロジェクトでは原則使えないため） ￼。|
|⸻|
|0) 何を使うか（最新版の指針）|
|	•	テキスト生成／編集（小説化・作家レビュー・ワンポイント）|
|推奨: gemini-2.5-flash（価格性能バランス）または gemini-2.5-pro（推論力が必要な場合）。2.0/2.5 は GA と明示、1.5 は新規利用不可。 ￼|
|	•	表紙の画像生成|
|推奨: Imagen 4（高品質）または Imagen 3 Fast/Generate（低遅延/標準）。モデルは Vertex AI の Imagen ファミリを使用。 ￼|
|	•	埋め込み（将来の検索や類似度用途）|
|gemini-embedding-001 を使用（現行安定かつ推奨）。 ￼|
|	•	SDK|
|@google/genai（Google Gen AI SDK） を採用。これは Gemini 2.x 機能に最速追従し、Vertex AI でも動作。旧 @google-cloud/vertexai は 2.0 以降の新機能は入らない旨が明記。 ￼|
|⸻|
|1) GCP 事前準備（初回のみ）|
|gcloud config set project vital-analogy-470911-t0|
|gcloud config set compute/region asia-northeast1|
|# API|
|gcloud services enable aiplatform.googleapis.com run.googleapis.com artifactregistry.googleapis.com|
|# Cloud Run 実行SA（まずはデフォルト）に Vertex AI 利用権限|
|PROJECT_NUM=830716651527|
|RUNTIME_SA="${PROJECT_NUM}-compute@developer.gserviceaccount.com"|
|gcloud projects add-iam-policy-binding vital-analogy-470911-t0 \|
|  --member="serviceAccount:${RUNTIME_SA}" \|
|  --role="roles/aiplatform.user"   # Vertex AI 呼び出しに必要|
|Vertex AI のアクセス制御は roles/aiplatform.user 付与が基本です。 ￼|
|⸻|
|2) リポ構成に「最小 API」を追加（Express）|
|前提: いまの Next.js は zine-app/ にあります。リポ直下に api/ を追加し、ここから Vertex を叩きます。|
|repo-root/|
|├─ zine-app/              # 既存（Next.js）|
|├─ api/                   # ← 新規（Cloud Run 用の最小バックエンド）|
|│  ├─ package.json|
|│  ├─ server.ts (or .js)|
|│  ├─ routes/|
|│  │  ├─ novelize.ts|
|│  │  ├─ review.ts|
|│  │  └─ cover.ts|
|│  └─ Dockerfile|
|└─ cloudbuild.yaml        # 既存/前回のままでOK（サービス名は web| api で分けても可）|
|2-1) 依存を追加|
|cd api|
|npm init -y|
|npm i express @google/genai @google-cloud/storage|
|npm i -D typescript ts-node @types/node @types/express|
|npx tsc --init|
|2-2) api/server.ts|
|import express from "express";|
|import bodyParser from "body-parser";|
|import { GoogleGenAI } from "@google/genai";        // 2.x 系推奨 SDK|
|import { Storage } from "@google-cloud/storage";|
|const app = express();|
|app.use(bodyParser.json());|
|// Vertex 設定（Cloud Run では ADC を使う）|
|// SDK は Vertex AI を使うとき `vertexai: true` と project/location を指定する。|
|const ai = new GoogleGenAI({|
|  vertexai: true| |
|  project: process.env.GOOGLE_CLOUD_PROJECT|   // Cloud Run が自動注入|
|  location: process.env.GOOGLE_CLOUD_LOCATION \|\| "asia-northeast1"| |
|});|
|// 1) 小説化: /novelize|
|app.post("/novelize"| async (req| res) => {|
|  const { concept| world| prompt } = req.body;|
|  const model = "gemini-2.5-flash"; // 価格性能バランス。必要なら 2.5-pro へ。|
|  const r = await ai.models.generateContent({|
|    model| |
|    contents: [|
|      `次の設定に基づいて日本語の小説本文を生成してください。|
|- コンセプト: ${concept}|
|- 世界観: ${world}|
|- 指示: ${prompt}|
|制約: 体裁を整え、章立てと見出しを入れる。`|
|    ]| |
|  });|
|  res.json({ text: r.text });|
|});|
|// 2) 作家レビュー/ワンポイント: /review|
|app.post("/review"| async (req| res) => {|
|  const { original| instruction } = req.body;|
|  const model = "gemini-2.5-flash";|
|  const r = await ai.models.generateContent({|
|    model| |
|    contents: [|
|      `以下の文章を、ユーザー指示に従って修正・推敲してください。|
|# 文章|
|${original}|
|# 指示|
|${instruction}|
|出力は修正後の本文のみ。`|
|    ]|
|  });|
|  res.json({ text: r.text });|
|});|
|// 3) 表紙生成: /cover  (Imagen で画像を生成して Cloud Storage に保存)|
|app.post("/cover"| async (req| res) => {|
|  const { synopsis } = req.body;|
|  const storage = new Storage();|
|  const bucketName = process.env.COVER_BUCKET!;|
|  const fileName   = `covers/${Date.now()}.png`;|
|  // 画像生成（Imagen）: 型は SDK の generateImages を利用|
|  // モデルは Imagen 3/4 系。まずは広く GA の "imagen-3.0-generate-001" を既定値に。|
|  // ※高品質なら "Imagen 4 for Generation" 系モデルに差し替え可（モデルIDはモデル一覧参照）。|
|  const imageResp = await ai.models.generateImages({|
|    model: "imagen-3.0-generate-001"| |
|    prompt: `本の表紙。落ち着いた色調。テーマに合う象徴的モチーフを含める。|
|小説の概要: ${synopsis}`| |
|    // 例: aspectRatio| safetyFilterLevel などのパラメータはモデル仕様に準拠|
|  });|
|  // 画像は base64 バイト列で返る想定|
|  const png = Buffer.from(imageResp.images![0].data| "base64");|
|  const bucket = storage.bucket(bucketName);|
|  await bucket.file(fileName).save(png| { contentType: "image/png" });|
|  const publicUrl = `https://storage.googleapis.com/${bucketName}/${fileName}`;|
|  res.json({ url: publicUrl });|
|});|
|app.get("/healthz"| (_| res) => res.json({ ok: true }));|
|const port = process.env.PORT \|\| 8080;|
|app.listen(port| "0.0.0.0"| () => {|
|  console.log(`api listening on ${port}`);|
|});|
|根拠:|
|・Gemini 2.x の generateContent/Stream を使うのが正道（2.0/2.5） ￼|
|・SDK 初期化で Vertex AI を直接指定できる（vertexai: true と project/location）。 ￼|
|・**Imagen（画像生成）**は Vertex AI の画像系モデル。モデル例と呼び出しは公式サンプルとドキュメント参照（imagen-3.0-generate-001 など）。 ￼|
|2-3) api/package.json|
|{|
|  "type": "module"| |
|  "scripts": {|
|    "dev": "ts-node server.ts"| |
|    "start": "node dist/server.js"| |
|    "build": "tsc -p ."|
|  }| |
|  "dependencies": {|
|    "@google/genai": "^1.16.0"| |
|    "@google-cloud/storage": "^7.12.0"| |
|    "express": "^4.19.2"|
|  }| |
|  "devDependencies": {|
|    "@types/express": "^4.17.21"| |
|    "@types/node": "^20.14.10"| |
|    "ts-node": "^10.9.2"| |
|    "typescript": "^5.6.2"|
|  }|
|}|
|2-4) api/Dockerfile|
|FROM node:20-alpine AS deps|
|WORKDIR /app|
|COPY package*.json ./|
|RUN npm ci|
|FROM node:20-alpine AS build|
|WORKDIR /app|
|COPY --from=deps /app/node_modules ./node_modules|
|COPY . .|
|RUN npm run build|
|FROM node:20-alpine|
|WORKDIR /app|
|ENV NODE_ENV=production|
|ENV GOOGLE_CLOUD_LOCATION=asia-northeast1|
|COPY --from=build /app/dist ./dist|
|COPY package*.json ./|
|RUN npm ci --omit=dev|
|EXPOSE 8080|
|CMD ["node"|dist/server.js"]
注: Cloud Storage に書き込みたい場合は、API 実行 SA に roles/storage.objectAdmin 等を付与してください。
⸻
3) フロント（Next.js）から呼ぶ
zine-app/.env.local（ビルド時読み込み）
NEXT_PUBLIC_API_BASE=https://<CloudRun(api)のURL>
例：小説化を叩くフック
export async function novelize(payload: {
  concept: string; world: string; prompt: string;
}) {
  const r = await fetch(`${process.env.NEXT_PUBLIC_API_BASE}/novelize`, {
    method: "POST| |
|    headers: { "Content-Type": "application/json" }| |
|    body: JSON.stringify(payload)| |
|  });|
|  return await r.json(); // { text }|
|}|
|⸻|
|4) 画像保存用バケット（任意）|
|gsutil mb -l asia-northeast1 gs://vital-analogy-470911-t0-covers|
|gsutil iam ch allUsers:objectViewer gs://vital-analogy-470911-t0-covers   # 公開URLで読むなら|
|COVER_BUCKET=vital-analogy-470911-t0-covers を Cloud Run 環境変数に設定。|
|⸻|
|5) Cloud Run へデプロイ（手動試験）|
|Artifact Registry は既に作成済みとして（まだなら作成）。|
|API コンテナ:|
|REGION=asia-northeast1|
|REPO=zine-repo|
|PROJECT_ID=vital-analogy-470911-t0|
|# Build & Push|
|gcloud builds submit api \|
|  --tag ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/api:latest|
|# Deploy|
|gcloud run deploy api \|
|  --image ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/api:latest \|
|  --region ${REGION} \|
|  --set-env-vars GOOGLE_CLOUD_LOCATION=asia-northeast1|COVER_BUCKET=vital-analogy-470911-t0-covers \|
|  --allow-unauthenticated|
|Cloud Run から Vertex AI を呼ぶための IAM（roles/aiplatform.user） は #1 で付与済みです。 ￼|
|⸻|
|6) CI へ統合（任意）|
|既存の cloudbuild.yaml に api ステップを追加（web と同様に build→push→deploy）。|
|GitHub 連携のトリガーは main ブランチに向けて設定すれば、push で自動反映されます（Cloud Build のクイックスタートを参照）。 ￼|
|⸻|
|7) 埋め込み（将来の検索/RAG用・任意）|
|gemini-embedding-001 を Google Gen AI SDK から呼べます。モデル名は バージョン付きで指定するのが推奨です。 ￼|
|// 例: /embed エンドポイント|
|app.post("/embed"| async (req| res) => {|
|  const { text } = req.body;|
|  const r = await ai.models.embedContent({|
|    model: "gemini-embedding-001"| |
|    contents: text|
|  });|
|  res.json({ vector: r.embedding }); // ベクトル配列|
|});|
|公式は「高品質には gemini-embedding-001」を推奨し、次元数や API 仕様もドキュメントにまとまっています。 ￼|
|⸻|
|8) モデル ID・ライフサイクルに関する注意|
|	•	1.5 Pro/Flash は新規プロジェクトで利用不可（2025/04/29 以降）。新規は 2.0/2.5 系を使う。 ￼|
|	•	最新モデル ID は 「Google models」ページで随時更新されます（2.5 Pro / 2.5 Flash / 2.5 Flash-Lite、Imagen 3/4 など）。実運用前にそこで確認してモデル名を反映してください。 ￼|
|⸻|
|9) ローカル開発のヒント|
|	•	ローカルから Vertex を叩くなら gcloud auth application-default login を一度実行（ADC）。Google Gen AI SDK のクイックスタートにも手順あり。 ￼ ￼|
|	•	環境変数（ローカル）|
|export GOOGLE_GENAI_USE_VERTEXAI=true|
|export GOOGLE_CLOUD_PROJECT=vital-analogy-470911-t0|
|export GOOGLE_CLOUD_LOCATION=asia-northeast1|
|→ SDK は自動で Vertex AI へ向きます。 ￼|
|⸻|
|10) これで実現できること（今回の3機能）|
|	1.	小説化: POST /novelize — gemini-2.5-flash で本文生成（必要に応じて 2.5-pro）。 ￼|
|	2.	作家レビュー/ワンポイント: POST /review — 同じく generateContent で指示に合わせて改稿。 ￼|
|	3.	表紙画像生成: POST /cover — Imagen 3/4 モデルで画像生成し Cloud Storage に保存。 ￼|
|⸻|
|補足の根拠リンク（主要）|
|	•	Gemini 2.5/2.0 とモデル一覧（1.5 新規不可告知含む）：Google models ページ。 ￼|
|	•	@google/genai（Google Gen AI SDK）Vertex AI 対応・初期化方法。 ￼|
|	•	Generate Content（Gemini）API 参考。 ￼ ￼|
|	•	Imagen（画像生成）とサンプル。 ￼|
|	•	Embedding（gemini-embedding-001）。 ￼|
|	•	Vertex AI の IAM（roles/aiplatform.user）。 ￼|
|⸻|
|これで、いまのフロントだけのリポに 最小 API を足して 最新版 Gemini/Imagen を実行する導線が揃います。|
|まずは api/ を追加 → Cloud Run にデプロイ → Next.js から叩く、の順で進めてください。必要に応じて、モデル ID を 2.5 系や Imagen 4 に切り替えるだけで最新状態を保てます。|
