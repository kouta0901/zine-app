結論（原因の芯）
小説モード本文に「謎のコード（長い英数字列）」が混入する主因は、テキストベース小説化フォールバック時に、data:image/...;base64,XXXX... のデータURLがそのままプロンプトに埋め込まれているためです。
該当箇所は extractZineContent() の画像要素処理。el.src がデータURLの場合でも、imageName = el.src.split('/')... のロジックが働き、base64を一部含む文字列が本文に流入します。その結果、モデルが「コードのような文字列」を本文に残す・エコーする事象が起きます。
さらに、APIエラーが出た後にテキストフォールバックへ流れると、この問題がより発現しやすくなります。
対処（即時の実装修正）
データURLを本文プロンプトに一切入れない（完全ブロック）
代わりに、画像の説明は OCR/キャプション・空間解析のテキストだけを使う
以下の2点を修正してください。
修正1: extractZineContent() でデータURL検知→人間可読の短い記述へ置換（base64を絶対に出力しない）

        sortedElements.forEach((el) => {
          if (el.type === "text") {
            if (el.content && el.content.trim() && el.content !== "クリックして編集") {
              content += `【テキスト】\n${el.content}\n\n`
            }
          } else if (el.type === "image") {
            content += `【画像】\n`

            // 画像の説明情報があれば追加（データURLは絶対に本文へ入れない）
            const isDataUrl = typeof el.src === 'string' && el.src.startsWith('data:image/')
            if (el.description) {
              content += `説明: ${el.description}\n`
            } else if (el.altText) {
              content += `内容: ${el.altText}\n`
            } else if (el.caption) {
              content += `キャプション: ${el.caption}\n`
            } else if (el.src && !isDataUrl) {
              const imageName = el.src.split('/').pop()?.split('?')[0] || '不明な画像'
              content += `内容: ${imageName}\n`
            } else {
              // データURLや不明ソースは人間可読な短い記述に固定
              content += `内容: キャンバス内イメージ（データURL）\n`
            }

            const position = getElementPosition(el)
            content += `配置: ${position}\n`

            const nearbyText = findNearbyText(el, sortedElements)
            if (nearbyText) {
              content += `関連テキスト: "${nearbyText.substring(0, 50)}..."\n`
            }

            content += "\n"
          } else if (el.type === "shape") {
            content += `【装飾】\n`
            content += `種類: 図形（${el.color || '色不明'}）\n\n`
          }
        })


修正2: 念のため、フォールバック直前にデータURLを一掃（保険）
        const zineContent = extractZineContent()
        // データURLの完全除去（保険）
        const sanitizedContent = zineContent
          .replace(/data:image\/[a-zA-Z0-9.+-]+;base64,[A-Za-z0-9+/=]+/g, '[image-data]')
          .replace(/\s{3,}/g, ' ')
        ...
        if (sanitizedContent && sanitizedContent.trim()) {
          prompt += "以下の設定とZINEコンテンツを基に小説を作成してください。\n\n"
          prompt += `${sanitizedContent}\n\n`
        } else {
          prompt += "以下の設定情報を基に小説を作成してください。\n\n"
        }

追加の健全化（推奨）
API成功ルート（/novelize-with-images）の利用を安定させる
Cloud Run の zine-api を最新版で再デプロイ（/novelize-with-images 実装済み版）
Networkタブで POST /novelize-with-images が 200/OK で返ること、Cloud Run ログに「Contents parts count: N」が出ることを確認
画像キャプチャを JPEG(品質0.7) にしてペイロード縮小（413対策、成功率↑）
html2canvas(...).toDataURL("image/jpeg", 0.7)
原因の裏取り
いまのコードは「テキストフォールバック」経路で el.src のデータURLを人間可読名に落とすつもりが、split('/') がデータURLにも作用し、png;base64,AAAA... のかたまりを拾ってしまいます。そのため、LLMが長いbase64断片を「本文」に混ぜ込む（または変換し損ねる）現象が起きます。
上記修正で、base64は完全にテキストプロンプトから排除され、画像の意味・配置・周辺テキストのみが渡るようになります。
動作確認のポイント
再実行後、小説本文から英数字の長大列が消える
APIルートがフォールバックせず、/novelize-with-images で完了
本文に画像内の看板・カード等の文字、色彩・構図・背景の描写が自然に反映される
必要なら、この修正を私の方でそのまま反映します。短時間で直る内容です。
サマリ
フォールバック時にデータURL（base64）がプロンプトへ混入→モデルがコード風文字列を出力。extractZineContent() の画像処理をデータURL完全ブロックへ修正。保険でフォールバック直前に正規表現で一掃。これで「謎コード」は解消され、画像の意味だけが小説へ反映されます。

---

## 現在のアーキテクチャ（ZINE→小説化の全体像）

### フロントエンド（Next.js 15 / React 19）
- 主要パス: `zine-app/app/page.tsx`, `zine-app/components/*`, `zine-app/lib/*`, `zine-app/types/*`
- 役割:
  - ギャラリー/ビューア/クリエイタ（ZINE/Novel）の画面遷移・UI
  - Gene(ZINE)→小説化のトリガと API 通信
  - 画像キャプチャ、（暫定）OCR/キャプション/空間解析ヘルパ
- APIクライアント: `zine-app/lib/api.ts`
  - `POST /novelize`（テキスト小説化）
  - `POST /novelize-with-images`（画像＋強化プロンプトで小説化）
  - `POST /review`（推敲/文体変更）
  - `POST /cover`（表紙生成）
  - `GET/POST/PUT/DELETE /zines*`（GCS保存/取得）

### バックエンド（Express on Cloud Run）
- 主要パス: `api/server.ts`
- 役割:
  - Vertex AI（Gemini 2.5/1.5）呼び出し
  - ZINEの GCS 保存/読み出し
  - 画像小説化（画像 `inlineData` を Gemini へ）とサーバ側解析（OCR/キャプション）
- エンドポイント:
  - `GET /healthz`
  - `POST /novelize`（テキストのみ）
  - `POST /novelize-with-images`（画像＋system/user/analysis プロンプト）
  - `POST /review`, `POST /cover`, `POST /embed`
  - `POST /zines`, `GET /zines`, `GET /zines/:id`, `PUT /zines/:id`, `DELETE /zines/:id`

### ストレージ
- Google Cloud Storage
  - `ZINES_BUCKET`: ZINE JSON（ページ要素/novelPages/メタ）
  - `COVER_BUCKET`: 生成された表紙画像（公開URL）

### Gene（ZINE）→小説化のデータフロー
1) ユーザ操作: クリエイタ画面で「小説化」クリック
2) 画像ベース経路（第一選択）
   - 各ページを `html2canvas` でキャプチャ（JPEG 0.7）→ `images[]`
   - 付帯情報（OCR/キャプション/空間解析/近接テキスト/信頼度）を整形 → `enhancedData[]`
   - `POST /novelize-with-images` に `images[]` と強化プロンプトを送信
   - サーバ側で必要に応じて再解析（Document AI / Gemini）→ Gemini 2.5 に画像＋テキスト投入 → 本文返却
3) フォールバック経路（画像失敗/413等）
   - ZINE要素（テキスト/画像の意味・配置/近接テキスト）を文字化
   - base64 データURLは完全除去 → `POST /novelize` に大規模プロンプト送信 → 本文返却
4) 生成後: 出力整形（見出し・メタの限定除去）→ ページ分割（`novelPages[]`）→ Novel ビューア/表紙生成へ連携

### デプロイ/設定
- Cloud Run: `zine-api`（us-central1）, `zine-app`（フロント）
- フロントは `NEXT_PUBLIC_API_BASE` で `zine-api` を参照
- API 環境変数: `GOOGLE_CLOUD_PROJECT`, `GOOGLE_CLOUD_LOCATION`, `ZINES_BUCKET`, `COVER_BUCKET`, `GOOGLE_API_KEY` ほか

### 重要な実装上のポイント（品質安定化）
- 画像は JPEG で送る（413回避）。サーバ側の `inlineData.mimeType` も `image/jpeg` に統一
- 画像ベース成功の指標: Cloud Run ログの `Image-based novel generation requested` と `Contents parts count`
- フォールバック経路では base64（dataURL）を絶対にプロンプトへ入れない（完全ブロック＋保険サニタイズ）
- 出力整形の正規表現は限定的にし、画像内短文ラベルまで削らない

### チェックリスト（反映確認）
- Network: `POST /novelize-with-images` が 200、本文生成が成功
- Cloud Run ログ: 画像枚数に応じた `parts` 数が出力
- 本文: base64 の断片が無い／画像内テキスト・配置・色彩/構図の描写が出ている

---

## 完全なアーキテクチャ図（Google Cloud Infrastructure）

```
                    ┌─────────────────────── ZINE アプリケーション全体図 ───────────────────────┐
                    │                                                                               │
                    │  ┌─────────────────────────────────── USER LAYER ──────────────────────┐    │
                    │  │                                                                       │    │
                    │  │ User (Browser) ──> HTTPS ──> Internet ──> Google Cloud Platform     │    │
                    │  └───────────────────────────────────────────────────────────────────────┘    │
                    │                                       │                                        │
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                                    GOOGLE CLOUD PLATFORM                                      ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃                                                                                               ┃
┃  ┌───────────────────────────────── COMPUTE LAYER ────────────────────────────────┐        ┃
┃  │                                                                                    │        ┃
┃  │   ┌─────────────────────────┐              ┌─────────────────────────┐          │        ┃
┃  │   │      Cloud Run          │              │      Cloud Run          │          │        ┃
┃  │   │                         │   HTTP/JSON  │                         │          │        ┃
┃  │   │    zine-app (Frontend)  │ <───────────>│    zine-api (Backend)   │          │        ┃
┃  │   │    us-central1          │              │    us-central1          │          │        ┃
┃  │   │                         │              │                         │          │        ┃
┃  │   │ • Next.js 15/React 19   │              │ • Express.js            │          │        ┃
┃  │   │ • TypeScript            │              │ • TypeScript            │          │        ┃
┃  │   │ • html2canvas           │              │ • Google Cloud SDK      │          │        ┃
┃  │   │ • Tailwind CSS          │              │                         │          │        ┃
┃  │   └─────────────────────────┘              └─────────┬───────────────┘          │        ┃
┃  │                                                      │                          │        ┃
┃  └──────────────────────────────────────────────────────┼──────────────────────────┘        ┃
┃                                                         │                                   ┃
┃  ┌───────────────────────── GOOGLE CLOUD AI SERVICES ──┼──────────────────────────┐        ┃
┃  │                                                      │                          │        ┃
┃  │  ┌─────────────────────┐    ┌─────────────────────┐  │  ┌─────────────────────┐  │        ┃
┃  │  │    Vertex AI        │    │    Document AI      │  │  │ Google Generative   │  │        ┃
┃  │  │                     │    │                     │  │  │      AI API         │  │        ┃
┃  │  │ • Gemini 2.5 Flash  │◄───┤ • OCR Processing    │◄─┼──┤ • Imagen 3          │  │        ┃
┃  │  │ • Text Generation   │    │ • Text Extraction   │  │  │ • Cover Generation  │  │        ┃
┃  │  │ • Image Captioning  │    │                     │  │  │   (Fallback)        │  │        ┃
┃  │  │ • Multimodal AI     │    │                     │  │  │                     │  │        ┃
┃  │  └─────────────────────┘    └─────────────────────┘  │  └─────────────────────┘  │        ┃
┃  │                                                      │                          │        ┃
┃  └──────────────────────────────────────────────────────┼──────────────────────────┘        ┃
┃                                                         │                                   ┃
┃  ┌──────────────────────────── STORAGE LAYER ──────────┼──────────────────────────┐        ┃
┃  │                                                      │                          │        ┃
┃  │  ┌─────────────────────┐    ┌─────────────────────┐  │  ┌─────────────────────┐  │        ┃
┃  │  │ Cloud Storage       │    │ Cloud Storage       │  │  │ Cloud Build         │  │        ┃
┃  │  │                     │    │                     │  │  │                     │  │        ┃
┃  │  │ ZINES_BUCKET       │◄───┤ COVERS_BUCKET       │◄─┼──┤ Build Artifacts     │  │        ┃
┃  │  │                     │    │                     │  │  │                     │  │        ┃
┃  │  │ • ZINE JSON Data    │    │ • Generated Covers  │  │  │ • Docker Images     │  │        ┃
┃  │  │ • Page Elements     │    │ • Public URLs       │  │  │ • Build Cache       │  │        ┃
┃  │  │ • Metadata          │    │                     │  │  │                     │  │        ┃
┃  │  └─────────────────────┘    └─────────────────────┘  │  └─────────────────────┘  │        ┃
┃  │                                                      │                          │        ┃
┃  └──────────────────────────────────────────────────────┼──────────────────────────┘        ┃
┃                                                         │                                   ┃
┃  ┌──────────────────────────── SECURITY & IAM ─────────┼──────────────────────────┐        ┃
┃  │                                                      │                          │        ┃
┃  │  ┌─────────────────────┐                            │                          │        ┃
┃  │  │ Service Account     │                            │                          │        ┃
┃  │  │                     │                            │                          │        ┃
┃  │  │ • Vertex AI Access  │◄───────────────────────────┘                          │        ┃
┃  │  │ • Cloud Storage     │                                                       │        ┃
┃  │  │ • Document AI       │                                                       │        ┃
┃  │  │ • Cloud Build       │                                                       │        ┃
┃  │  └─────────────────────┘                                                       │        ┃
┃  │                                                                                │        ┃
┃  └────────────────────────────────────────────────────────────────────────────────┘        ┃
┃                                                                                               ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

## 詳細なデータフロー図（ZINE→小説化プロセス）

```
┌──────────────────────── USER INTERACTION ────────────────────────┐
│                                                                   │
│  User clicks "小説化" in ZINE Creator                            │
│                                                                   │
└───────────────────────────────┬───────────────────────────────────┘
                                │
┌───────────────────────────────▼───────────────────────────────────┐
│                        FRONTEND PROCESSING                        │
│                      (zine-app/components)                        │
├───────────────────────────────────────────────────────────────────┤
│                                                                   │
│  Step 1: Image Capture & Processing                               │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │ • html2canvas(canvas, {quality: 0.7, format: 'jpeg'})      │  │
│  │ • Convert each page to base64 JPEG                          │  │
│  │ • Store in images[] array                                   │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                   │
│  Step 2: Spatial & Content Analysis                               │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │ • extractZineContent() - parse all elements                 │  │
│  │ • getElementPosition() - normalize coordinates (1400x900)   │  │
│  │ • findNearbyText() - directional proximity detection        │  │
│  │ • Build enhancedData[] with spatial context                 │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                   │
│  Step 3: Route Decision                                            │
│  ┌─────────────────┐                  ┌─────────────────────────┐  │
│  │ images.length   │                  │ No images or            │  │
│  │ > 0?           ├─── YES ──────────┤ POST request failed?    │  │
│  │                │                  │                         │  │
│  └─────────────────┘                  └─────────┬───────────────┘  │
│                                                │                  │
└───────────────────────────────────────────────┬─┼──────────────────┘
                                                │ │
        ┌───────────────────────────────────────┘ │
        │ PRIMARY ROUTE                           │ FALLBACK ROUTE
        ▼                                         ▼
┌─────────────────────────────┐         ┌─────────────────────────┐
│    IMAGE-BASED PROCESSING   │         │   TEXT-BASED FALLBACK   │
│  (POST /novelize-with-images)│         │   (POST /novelize)      │
├─────────────────────────────┤         ├─────────────────────────┤
│                             │         │                         │
│ ┌─ CLOUD RUN API (server) ─┐│         │ ┌─ SANITIZATION ──────┐ │
│ │                         ││         │ │                     │ │
│ │ 1. Receive Request      ││         │ │ • Strip data:image  │ │
│ │    { images, concept,   ││         │ │ • Remove base64     │ │
│ │      world, enhanced }  ││         │ │ • Keep text only    │ │
│ │                         ││         │ └─────────────────────┘ │
│ │ 2. Server-Side AI       ││         │                         │
│ │ ┌─ Document AI ──────┐  ││         │ ┌─ VERTEX AI ─────────┐ │
│ │ │ • OCR Processing   │  ││         │ │                     │ │
│ │ │ • Text Extraction  │  ││         │ │ • Text-only prompt  │ │
│ │ │ • Confidence Score │  ││         │ │ • Gemini 2.5 Flash  │ │
│ │ └────────────────────┘  ││         │ │ • Generate novel    │ │
│ │                         ││         │ └─────────────────────┘ │
│ │ ┌─ Vertex AI ────────┐  ││         │                         │
│ │ │ • Image Captioning │  ││         └─────────────────────────┘
│ │ │ • Visual Analysis  │  ││                         │
│ │ │ • Gemini 2.5 Flash │  ││                         │
│ │ └────────────────────┘  ││                         │
│ │                         ││                         │
│ │ 3. Enhanced Prompt      ││                         │
│ │ ┌─ Multimodal Input ─┐  ││                         │
│ │ │ • Images (inline)  │  ││                         │
│ │ │ • OCR Text         │  ││                         │
│ │ │ • Captions         │  ││                         │
│ │ │ • Spatial Context  │  ││                         │
│ │ │ • Nearby Text      │  ││                         │
│ │ └────────────────────┘  ││                         │
│ │                         ││                         │
│ │ 4. Vertex AI Generation ││                         │
│ │ ┌─ Final Processing ─┐  ││                         │
│ │ │ • Gemini 2.5 Flash │  ││                         │
│ │ │ • Multi-image      │  ││                         │
│ │ │ • Rich context     │  ││                         │
│ │ │ • Novel output     │  ││                         │
│ │ └────────────────────┘  ││                         │
│ └─────────────────────────┘│                         │
└─────────────────────────────┘                         │
                │                                       │
                └───────────────┬───────────────────────┘
                                │
┌───────────────────────────────▼───────────────────────────────────┐
│                       RESPONSE PROCESSING                         │
│                        (Frontend Cleanup)                         │
├───────────────────────────────────────────────────────────────────┤
│                                                                   │
│  Step 1: Text Sanitization                                        │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │ • megaTitleBlocker() - Remove excessive headers              │  │
│  │ • Preserve image-derived content                             │  │
│  │ • Clean format artifacts                                     │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                   │
│  Step 2: Pagination                                               │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │ • Split into novelPages[] array                              │  │
│  │ • Maintain narrative flow                                    │  │
│  │ • Preserve paragraph structure                               │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                   │
│  Step 3: State Update & Navigation                                │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │ • Update SavedZineData with novelPages                       │  │
│  │ • Switch to Novel Viewer mode                                │  │
│  │ • Enable cover generation                                    │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
                                │
┌───────────────────────────────▼───────────────────────────────────┐
│                         NOVEL VIEWER                              │
│                                                                   │
│  • Display paginated novel content                                │
│  • Navigation controls                                            │
│  • Cover generation option                                        │
│  • Export/sharing functionality                                   │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

## APIエンドポイント詳細仕様

### 1. POST /novelize-with-images
**目的**: 画像付きZINEを小説化する主要エンドポイント

**リクエスト形式**:
```typescript
{
  concept: string;           // コンセプト設定
  world: string;            // 世界観設定  
  images: string[];         // base64エンコードされたJPEG画像配列
  title: string;            // ZINE タイトル
  imageDescriptions?: string[];     // 画像説明（オプション）
  detailedPrompt?: string;         // 詳細プロンプト（オプション）
  enhancedAnalysis?: Array<{       // 強化解析データ（オプション）
    imageBase64: string;
    ocrText: string;
    caption: string; 
    nearbyText: string;
    spatialContext: string;
    pageIndex: number;
    confidence: number;
  }>;
}
```

**処理フロー**:
1. **画像前処理**: base64デコード、形式検証
2. **Document AI OCR**: 各画像のテキスト抽出
3. **Vertex AI Captioning**: 各画像の視覚的説明生成
4. **プロンプト構築**: システム・ユーザー・解析プロンプトの結合
5. **Multimodal AI**: Gemini 2.5 Flashに画像+テキストで生成依頼
6. **レスポンス**: `{ text: string }` 形式で小説本文を返却

### 2. POST /novelize
**目的**: テキストのみの小説化（フォールバック）

**リクエスト形式**:
```typescript
{
  concept: string;    // コンセプト設定
  world: string;      // 世界観設定
  prompt: string;     // テキスト化されたZIEN内容
}
```

### 3. Additional Endpoints
- `POST /review`: 作家レビュー・推敲機能
- `POST /cover`: AI表紙生成
- `GET/POST/PUT/DELETE /zines/*`: ZINE CRUD操作


進捗メモ: 影響箇所を特定済みなので、「画像ベースAPIに一本化」するための編集計画と具体的な編集内容を出します。この後、そのまま反映できるコード案を提示します。

### 方針（最重要）
- 小説生成は常に `novelizeWithImagesEnhanced`（= POST `/novelize-with-images`）のみを使う。
- `novelize`（= POST `/novelize`）の呼び出し・フォールバック分岐をすべて廃止。
- 画像が無い場合はエラー表示で中断（自動画像化は任意）。ZINEモードでは画像やテキスト要素が前提。

### 影響箇所（要修正）
- `zine-app/lib/api.ts`
  - `novelize` のエクスポートを廃止（または非推奨コメントアウト）
- `zine-app/components/zine-creator.tsx`
  - `handleNovelize` の分岐とフォールバックから `novelize` 呼び出しを削除
  - 常に `extractZineImages()` → `novelizeWithImagesEnhanced(...)`
  - `images.length === 0` はアラート表示して中断
  - `novelize` の import を削除
- `zine-app/components/writing-workspace.tsx`
  - `novelize` の import と使用を削除
  - テキスト生成ボタンは、テキストを1枚の画像にレンダリングして `novelizeWithImagesEnhanced` を呼ぶ方式に変更（テキスト主体ワークスペースでもAPI一本化）

### 具体的な編集案

1) `zine-app/lib/api.ts`
- `novelize` を削除（またはコメントアウト）。以降は `novelizeWithImagesEnhanced` のみ使用。

```23:31:zine-app/lib/api.ts
// 小説化機能（テキストのみ）— 廃止
// export async function novelize(payload: {
//   concept: string;
//   world: string;
//   prompt: string;
// }): Promise<{ text: string }> {
//   return apiCall("/novelize", payload);
// }
```

2) `zine-app/components/zine-creator.tsx`
- `handleNovelize` を画像ベース固定に。`images.length === 0` は中断。
- 画像ルート失敗時の `/novelize` フォールバックも削除。
- 冒頭の `novelize` import も削除。

```1943:2051:zine-app/components/zine-creator.tsx
  // 小説化機能（画像ベース）
  const handleNovelize = async () => {
    console.log("🎬 Starting image-based novel generation...")

    const concept = `${conceptConfig.genre} ${conceptConfig.keywords}`
    const characters = (worldviewConfig.characters || []).map((c: any, idx: number) => `人物${idx + 1}: ${c.name}（性格: ${c.personality}）`).join(" / ")
    const world = `舞台: ${worldviewConfig.stage}\n${characters}\nシナリオ: ${worldviewConfig.scenario}`

    setIsGeneratingNovel(true)

    try {
      // ZINEページを画像化（Enhanced AI Analysis）
      console.log("📸 Extracting ZINE images with AI enhancement...")
      const { images, title, descriptions, enhancedData } = await extractZineImages()

      if (images.length === 0) {
        alert("小説化にはZINEページに画像またはテキスト要素が必要です。ページに要素を追加してください。")
        return
      }

      console.log(`🖼️ Generating enhanced novel from ${images.length} ZINE images...`)

      const result = await novelizeWithImagesEnhanced({
        concept,
        world,
        images,
        title,
        imageDescriptions: descriptions,
        enhancedAnalysis: enhancedData,
        detailedPrompt: `
          【強化AI解析による高精度小説生成】
          Document AI OCRとVertex AI Geminiを使用した詳細分析結果を基に、画像の内容を100%反映した小説を生成してください。
          ...（既存の強化指示を維持）...
        `
      })

      let cleanedText = result.text
      const linesToRemove = [
        /^タイトル[:：].*$/gm,
        /^概要[:：].*$/gm,
        /^設定[:：].*$/gm,
        /^ジャンル[:：].*$/gm,
        /^キャラクター[:：].*$/gm,
        /^登場人物[:：].*$/gm,
        /^あらすじ[:：].*$/gm,
        /^シナリオ[:：].*$/gm,
        /^[【］[\w\s]*[】]/gm,
        /^##?\s.*$/gm,
        /^-{3,}$/gm,
        /^={3,}$/gm,
      ]
      linesToRemove.forEach(pattern => {
        cleanedText = cleanedText.replace(pattern, '')
      })
      cleanedText = cleanedText.replace(/\n\s*\n\s*\n/g, '\n\n').trim()

      console.log("✅ Image-based novel generation completed")
      setNovelContent(cleanedText)
      const splitPages = splitNovelContent(cleanedText)
      setNovelPages(splitPages)
      setCurrentNovelPage(1)
      setMode("novel")
    } catch (error) {
      console.error("❌ Image-based novel generation error:", error)
      alert(`画像ベース小説生成に失敗しました。ページに要素があるか、画像サイズが大きすぎないかを確認し、再試行してください。`)
    } finally {
      setIsGeneratingNovel(false)
    }
  }
```

3) `zine-app/components/writing-workspace.tsx`
- import を `novelize` から `novelizeWithImagesEnhanced` に変更。
- `handleNovelize` を「テキスト→画像化→`novelizeWithImagesEnhanced`」に置換。

```9:9:zine-app/components/writing-workspace.tsx
-import { novelize, review, generateCover } from "@/lib/api"
+import { novelizeWithImagesEnhanced, review, generateCover } from "@/lib/api"
```

```53:70:zine-app/components/writing-workspace.tsx
  // 小説化機能（テキスト→画像化して画像APIへ）
  const handleNovelize = async () => {
    if (!concept || !world || !prompt) {
      alert("コンセプト、世界観、プロンプトをすべて入力してください。")
      return
    }

    setIsGenerating(true)
    try {
      // 一時DOMにテキストを描画して画像化（簡易）
      const el = document.createElement("div")
      el.style.width = "800px"
      el.style.padding = "24px"
      el.style.fontSize = "16px"
      el.style.lineHeight = "1.8"
      el.style.whiteSpace = "pre-wrap"
      el.style.background = "#ffffff"
      el.style.color = "#000000"
      el.innerText = `【コンセプト】\n${concept}\n\n【世界観】\n${world}\n\n【指示】\n${prompt}`
      document.body.appendChild(el)
      const canvas = await (await import("html2canvas")).default(el, { backgroundColor: "#fff", scale: 2 })
      document.body.removeChild(el)
      const dataUrl = canvas.toDataURL("image/jpeg", 0.7)

      const result = await novelizeWithImagesEnhanced({
        concept,
        world,
        images: [dataUrl],
        title: "TextOnly",
        imageDescriptions: ["Text prompt rendered as a single page"],
        enhancedAnalysis: []
      })
      setGeneratedContent(result.text)
    } catch (error) {
      console.error("小説化エラー:", error)
      alert("小説の生成に失敗しました。")
    } finally {
      setIsGenerating(false)
    }
  }
```

### 動作確認チェック
- ZINEモードの「小説化ボタン」:
  - Network: `POST /novelize-with-images` のみ呼び出される
  - Cloud Run ログ: 画像数＋テキスト parts のカウントが出力
- Writing Workspace:
  - ボタンで1枚画像生成→同API呼び出し→本文表示
- 画像0のZINEで小説化:
  - APIを呼ばずにアラート表示（分岐廃止により `/novelize` へは行かない）

補足（任意）
- サーバ側 `/novelize` の削除は後段階でOK。まずはフロントからの参照をゼロに。
- 413回避のため、`toDataURL("image/jpeg", 0.7)` を維持。ページ数が多い場合は段階送信も検討。

要約
- フロントの小説生成をすべて `novelizeWithImagesEnhanced` に統一。
- `zine-creator.tsx` の分岐/フォールバックを削除し、画像必須で固定。
- `writing-workspace.tsx` もテキストを画像化して同APIを使用。


これから「画像APIに一本化」の修正を実装します。まずTODOを作成し、続いて影響ファイルを並行で編集します。

[1 tool called]

今からファイルを編集します。まず `lib/api.ts` の `novelize` を無効化して一本化の下準備を行います。次に `zine-creator.tsx` の分岐/フォールバックを削除して画像API固定にします。その後 `writing-workspace.tsx` をルーティング/メニューから非表示にします。

[4 tools called]

今から `lib/api.ts` と `components/zine-creator.tsx` を編集します。まず `novelize` を無効化し、`zine-creator.tsx` の分岐とフォールバックを削除して画像APIに固定します。続けてTODOを更新します。

[10 tools called]

進捗メモ: 画像API一本化の実装を反映しました。`lib/api.ts` から `novelize` を無効化し、`zine-creator.tsx` は画像ベース固定、`writing-workspace.tsx` はUI上で無効化しました。型/リンターは問題ありません。

変更点
- `zine-app/lib/api.ts`
  - `novelize` を廃止（コメントアウト）。今後は `novelizeWithImagesEnhanced` のみ使用。
- `zine-app/components/zine-creator.tsx`
  - import から `novelize` を削除。
  - 小説生成の分岐/フォールバックを削除。画像が0枚なら警告表示で中断し、常に `novelizeWithImagesEnhanced` を呼ぶように統一。
- `zine-app/components/writing-workspace.tsx`
  - `novelize` の import を削除。
  - 小説生成ボタンはアラート表示のみ（非表示の代替として機能無効化）。画面コード自体は残置。

確認ポイント
- ZINEモードで小説化時、Network が `POST /novelize-with-images` のみになること。
- 画像が0枚だとアラートで中断すること。
- `writing-workspace.tsx` は今後使わない想定で、押下時に無効化アラートが出ること。

質問への回答
- ご認識どおり、`writing-workspace.tsx` は現状使わない方針で合っています。UI動線からの利用を事実上止め、コードは残しています。

要約
- 小説生成フローを完全に `novelize-with-images` に統一。
- ZINEモードでは画像必須。フォールバック（/novelize）は撤廃。
- テキスト執筆ワークスペースは無効化し、将来の再利用に備えてコードは保持。

今からローカル環境で API とフロントを起動します。まず各ディレクトリで依存関係をインストールし、その後 API(8080) → フロント(3000) をバックグラウンドで立ち上げます。

[4 tools called]

進捗メモ: ローカルで API(8080) とフロント(3000) をバックグラウンド起動しました。ブラウザから確認に進みます。

- 確認手順
  - フロント: `http://localhost:3000`
  - API ヘルスチェック: `http://localhost:8080/healthz`

- 期待挙動
  - ZINEモードで「小説化」を押下 → `POST /novelize-with-images` のみ呼ばれる
  - 画像0枚ならアラートで中断
  - 成功時は `mode === "novel"` に切替され本文が表示

要約
- ローカル起動済み。フロントは `NEXT_PUBLIC_API_BASE=http://localhost:8080` で API に接続しています。ブラウザで挙動をご確認ください。

[6 tools called]

進捗メモ: 問題の原因はフロント側 `ocr.ts` のモックOCR文字列がそのまま本文に混入していたことです。モック返却を空に変更し、型エラーも解消しました。

対応
- `zine-app/lib/ocr.ts`
  - ブラウザ/未設定時のモックを「空の結果」を返すよう変更
    - 以前: サンプル文言を返却（混入原因）
    - 現在: `text: ""`, `words: []`, `paragraphs: []`, `confidence: 0`
  - 例外処理を安全化（unknown対応）

次の確認
- ZINEモードで再度「小説化」を実行し、本文内に
  - “サンプルタイトル” や “説明文やキャプション…” 等が出ないこと
  - “Mock OCR result ...” 由来の文言が消えていること
- まだ残る場合は、キャプション側のモックもチェックしますが、現状 `captioning.ts` はモック文字列を埋め込んでいない構成です。

要約
- モックOCRテキストが混入する経路を遮断しました。小説本文から不要文言は出なくなります。